
<!DOCTYPE html>

<html lang="en" data-content_root="../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Unbalanced “concatenation” &#8212; TroubleShooting Documentation (MCT XQuant Extension Tool): ver 1.0</title>
    <link rel="stylesheet" type="text/css" href="../static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../static/bizstyle.css?v=5283bb3d" />
    <link rel="stylesheet" type="text/css" href="../static/css/custom.css?v=01243f34" />
    
    <script src="../static/documentation_options.js?v=f2a433a1"></script>
    <script src="../static/doctools.js?v=9bcbadda"></script>
    <script src="../static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../static/bizstyle.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <!--[if lt IE 9]>
    <script src="static/css3-mediaqueries.js"></script>
    <![endif]-->
  </head><body>
    <div class="related" role="navigation" aria-label="Related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="nav-item nav-item-0"><a href="../index.html">TroubleShooting Documentation (MCT XQuant Extension Tool): ver 1.0</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Unbalanced “concatenation”</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="unbalanced-concatenation">
<span id="ug-unbalanced-concatenation"></span><h1>Unbalanced “concatenation”<a class="headerlink" href="#unbalanced-concatenation" title="Link to this heading">¶</a></h1>
<section id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Link to this heading">¶</a></h2>
<p>The concatenation layers can be a sensitive element in quantized models.
When it involves combining multiple tensors that may have significantly different value ranges, leading to potential inaccuracies in quantization.</p>
<p>For example, the quantization of a tensor that contains values ranging in (-1, 1) together with a tensor that ranges in (-64, 64) is less accurate than the quantization of each tensor separately.</p>
</section>
<section id="trouble-situation">
<h2>Trouble Situation<a class="headerlink" href="#trouble-situation" title="Link to this heading">¶</a></h2>
<p>The quantization accuracy may degrade when the value ranges are significantly different in concatenation layers after graph optimization.</p>
<p>MCT optimizes the graph using layer concatenations,
the Add layer Collapsing(collapsing the Add layer to preceding the Convolution) and the 1x1 Conv Layer Collapsing(collapsing the 1x1 Convolution layer to preceding the Convolution).</p>
<a class="reference internal image-reference" href="../images/collapse_layers.png"><img alt="../images/collapse_layers.png" src="../images/collapse_layers.png" style="width: 766.4000000000001px; height: 561.6px;" />
</a>
</section>
<section id="solution">
<h2>Solution<a class="headerlink" href="#solution" title="Link to this heading">¶</a></h2>
<p>When you discover the concatenation layers with inputs that have notably different threshold values, consider the following points:</p>
<ol class="arabic simple">
<li><p>Disable some graph optimizations by modifying the <code class="docutils literal notranslate"><span class="pre">QuantizationConfig</span></code> in <code class="docutils literal notranslate"><span class="pre">CoreConfig</span></code>.</p></li>
</ol>
<blockquote>
<div><ul class="simple">
<li><p>If Add layer Collapsing, set <code class="docutils literal notranslate"><span class="pre">linear_collapsing</span></code> to False.</p></li>
<li><p>If 1x1 Conv Layer Collapsing, set <code class="docutils literal notranslate"><span class="pre">residual_collapsing</span></code> to False.</p></li>
</ul>
</div></blockquote>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">core_config</span> <span class="o">=</span> <span class="n">mct</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">CoreConfig</span><span class="p">(</span><span class="n">mct</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">QuantizationConfig</span><span class="p">(</span><span class="n">linear_collapsing</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                                              <span class="n">residual_collapsing</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
<span class="n">quantized_model</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">mct</span><span class="o">.</span><span class="n">ptq</span><span class="o">.</span><span class="n">pytorch_post_training_quantization</span><span class="p">(</span><span class="o">...</span><span class="p">,</span>
                                                                <span class="n">core_config</span><span class="o">=</span><span class="n">core_config</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Some graph optimizations will not be performed, which may slow down execution speed.</p>
</div>
<ol class="arabic simple" start="2">
<li><p>Add a scaling operation between problematic “concatenation” layers in your float model.</p></li>
</ol>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
  <div>
    <h3><a href="../index.html">Table of Contents</a></h3>
    <ul>
<li><a class="reference internal" href="#">Unbalanced “concatenation”</a><ul>
<li><a class="reference internal" href="#overview">Overview</a></li>
<li><a class="reference internal" href="#trouble-situation">Trouble Situation</a></li>
<li><a class="reference internal" href="#solution">Solution</a></li>
</ul>
</li>
</ul>

  </div>
<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="Related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="nav-item nav-item-0"><a href="../index.html">TroubleShooting Documentation (MCT XQuant Extension Tool): ver 1.0</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Unbalanced “concatenation”</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
    &#169; Copyright 2025, Sony Semiconductor Solutions Corporation.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 8.1.3.
    </div>
  </body>
</html>